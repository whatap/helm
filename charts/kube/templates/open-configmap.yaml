{{ if .Values.deploymentOpen.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: whatap-open-agent-config
  namespace: {{ .Release.Namespace }}
data:
  scrape_config.yaml: |
    {{- $root := . }}
    {{- $open := .Values.deploymentOpen.config.features.openAgent }}
    #configuration
    #CR format configuration
    features:
      openAgent:
        enabled: {{ $open.enabled | default true }}
        {{- with $open.globalInterval }}
        globalInterval: {{ . | quote }}
        {{- end }}
        {{- with $open.globalPath }}
        globalPath: {{ . | quote }}
        {{- end }}
        targets:
        {{- range $target := $open.targets }}
          - targetName: {{ $target.targetName }}
            {{- if hasKey $target "enabled" }}
            enabled: {{ default true $target.enabled }}
            {{- end }}
            type: {{ $target.type }}
            {{- if and $target.namespaceSelector (or (eq $target.type "PodMonitor") (eq $target.type "ServiceMonitor")) }}
            namespaceSelector:
              {{- with $target.namespaceSelector.matchNames }}
              matchNames:
              {{- range . }}
                - {{ . | quote }}
              {{- end }}
              {{- end }}
              {{- with $target.namespaceSelector.matchLabels }}
              matchLabels:
              {{- range $key, $value := . }}
                {{ $key }}: {{ $value | quote }}
              {{- end }}
              {{- end }}
              {{- with $target.namespaceSelector.matchExpressions }}
              matchExpressions:
              {{- range . }}
                - key: {{ .key }}
                  operator: {{ .operator }}
                  {{- if .values }}
                  values:
                  {{- range .values }}
                    - {{ . | quote }}
                  {{- end }}
                  {{- end }}
              {{- end }}
              {{- end }}
            {{- end }}
            {{- if $target.selector }}
            selector:
              {{- with $target.selector.matchLabels }}
              matchLabels:
              {{- range $key, $value := . }}
                {{ $key }}: {{ $value | quote }}
              {{- end }}
              {{- end }}
              {{- with $target.selector.matchExpressions }}
              matchExpressions:
              {{- range . }}
                - key: {{ .key }}
                  operator: {{ .operator }}
                  {{- if .values }}
                  values:
                  {{- range .values }}
                    - {{ . | quote }}
                  {{- end }}
                  {{- end }}
              {{- end }}
              {{- end }}
            {{- end }}
            {{- if $target.endpoints }}
            endpoints:
              {{- range $ep := $target.endpoints }}
              {{- $path := default $open.globalPath $ep.path }}
              {{- $interval := default $open.globalInterval $ep.interval }}
              {{- $isStatic := eq $target.type "StaticEndpoints" }}
              {{- $endpointValue := ternary $ep.address $ep.port $isStatic }}
              - {{- if $isStatic }}address{{ else }}port{{ end }}: {{ $endpointValue | quote }}
                {{- if $path }}
                path: {{ $path | quote }}
                {{- end }}
                {{- if $interval }}
                interval: {{ $interval | quote }}
                {{- end }}
                {{- if $ep.scheme }}
                scheme: {{ $ep.scheme | quote }}
                {{- end }}
                timeout: {{ default "30s" $ep.timeout | quote }}
                {{- if hasKey $ep "addNodeLabel" }}
                addNodeLabel: {{ default false $ep.addNodeLabel }}
                {{- end }}
                {{- with $ep.tlsConfig }}
                tlsConfig:
                  {{- if hasKey . "insecureSkipVerify" }}
                  insecureSkipVerify: {{ default false .insecureSkipVerify }}
                  {{- end }}
                  {{- if .caFile }}
                  caFile: {{ .caFile | quote }}
                  {{- end }}
                  {{- if .certFile }}
                  certFile: {{ .certFile | quote }}
                  {{- end }}
                  {{- if .keyFile }}
                  keyFile: {{ .keyFile | quote }}
                  {{- end }}
                  {{- if .serverName }}
                  serverName: {{ .serverName | quote }}
                  {{- end }}
                {{- end }}
                {{- with $ep.metricRelabelConfigs }}
                metricRelabelConfigs:
                  {{- range $m := . }}
                  - {{- if $m.source_labels }}
                    source_labels: [{{ join ", " $m.source_labels }}]
                    {{- end }}
                    {{- if $m.separator }}
                    separator: {{ $m.separator | quote }}
                    {{- end }}
                    {{- if $m.target_label }}
                    target_label: {{ $m.target_label | quote }}
                    {{- end }}
                    {{- if $m.regex }}
                    regex: {{ $m.regex | quote }}
                    {{- end }}
                    {{- if $m.replacement }}
                    replacement: {{ $m.replacement | quote }}
                    {{- end }}
                    {{- if $m.action }}
                    action: {{ $m.action }}
                    {{- end }}
                  {{- end }}
                {{- end }}
              {{- end }}
            {{- end }}
        {{- end }}
        {{- if $root.Values.addon.gpu.enabled }}
          # Auto-generated dcgm-exporter target when GPU is enabled
          - targetName: dcgm-exporter-auto
            enabled: true
            type: PodMonitor
            namespaceSelector:
              matchNames:
                - {{ $root.Release.Namespace | quote }}
            selector:
              matchLabels:
                name: "whatap-node-agent"
            endpoints:
              - port: "9400"
                path: "/metrics"
                interval: "30s"
                scheme: "http"
                timeout: "30s"
                addNodeLabel: true
                metricRelabelConfigs:
                  - target_label: wtp_src
                    replacement: "true"
                    action: replace
                  - source_labels: [__name__]
                    regex: "DCGM.*"
                    action: keep
              - port: "9400"
                path: "/metrics/process"
                interval: "30s"
                scheme: "http"
                timeout: "30s"
                addNodeLabel: true
                metricRelabelConfigs:
                  - target_label: wtp_src
                    replacement: "true"
                    action: replace
                  - source_labels: [__name__]
                    regex: "DCGM.*"
                    action: keep
        {{- end }}
{{ end }}
